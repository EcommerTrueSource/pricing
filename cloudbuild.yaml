steps:
# Build da imagem
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'southamerica-east1-docker.pkg.dev/${PROJECT_ID}/pricing-repo/pricing:${SHORT_SHA}', '.']

# Push para o Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'southamerica-east1-docker.pkg.dev/${PROJECT_ID}/pricing-repo/pricing:${SHORT_SHA}']

# Deploy no Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
  - 'run'
  - 'deploy'
  - 'pricing'
  - '--image=southamerica-east1-docker.pkg.dev/${PROJECT_ID}/pricing-repo/pricing:${SHORT_SHA}'
  - '--region=southamerica-east1'
  - '--platform=managed'
  - '--allow-unauthenticated'
  - '--set-secrets=/secrets/.env.local=env_pricing:latest'
  - '--update-env-vars=DOTENV_PATH=/secrets/.env.local'
  - '--set-cloudsql-instances=${PROJECT_ID}:southamerica-east1:pricing'
  - '--service-account=pricing-contract@${PROJECT_ID}.iam.gserviceaccount.com'
  - '--memory=1Gi'
  - '--cpu=1'

# Criar job de migração do Prisma
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
  - 'run'
  - 'jobs'
  - 'create'
  - 'pricing-migrate-${SHORT_SHA}'
  - '--image=southamerica-east1-docker.pkg.dev/${PROJECT_ID}/pricing-repo/pricing:${SHORT_SHA}'
  - '--set-secrets=/secrets/.env.local=env_pricing:latest,/secrets/database_url=database_url_pricing:latest'
  - '--update-env-vars=NODE_ENV=production'
  - '--set-cloudsql-instances=${PROJECT_ID}:southamerica-east1:pricing'
  - '--command=sh,-c,echo "[Debug] Iniciando processo de migração..." && \
     echo "[Debug] Verificando diretório atual:" && pwd && \
     echo "[Debug] Listando arquivos:" && ls -la && \
     echo "[Debug] Verificando secrets:" && ls -la /secrets/ && \
     echo "[Debug] Verificando variáveis:" && env | grep -v "KEY\|SECRET\|PASSWORD" && \
     echo "[Debug] Verificando conexão com banco:" && nc -zv localhost 5432 && \
     echo "[Debug] Configurando DATABASE_URL..." && export DATABASE_URL=$(cat /secrets/database_url) && \
     echo "[Debug] Gerando cliente Prisma..." && npx prisma generate && \
     echo "[Debug] Executando migração..." && npx prisma migrate deploy'
  - '--region=southamerica-east1'
  - '--tasks=1'
  - '--memory=512Mi'
  - '--cpu=1'
  - '--max-retries=3'
  - '--service-account=pricing-contract@${PROJECT_ID}.iam.gserviceaccount.com'
  - '--timeout=600s'
  - '--task-timeout=600s'

# Executar job de migração
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
  - 'run'
  - 'jobs'
  - 'execute'
  - 'pricing-migrate-${SHORT_SHA}'
  - '--region=southamerica-east1'
  - '--wait'

# Verificar se a aplicação está saudável
- name: 'gcr.io/cloud-builders/curl'
  args: ['--retry', '5', '--retry-delay', '10', '-s', '-o', '/dev/null', '-w', '%{http_code}', 'https://pricing-460815276546.southamerica-east1.run.app/api/health']

images:
- 'southamerica-east1-docker.pkg.dev/${PROJECT_ID}/pricing-repo/pricing:${SHORT_SHA}'

timeout: '1800s'
